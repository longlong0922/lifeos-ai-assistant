# 🤖 LifeOS LLM Agent 工作原理详解

## 🎯 这个 Agent 是干什么的？

### 简单理解
**LifeOS 是一个智能生活助手**，它像一个聪明的朋友，可以：
- 💬 和你聊天
- 🏃 帮你追踪习惯
- 🔮 帮你做决策
- 📋 给你每日计划
- 💭 陪你反思
- 🎯 帮你拆解目标

---

## 🧠 工作流程（5步）

### 1️⃣ 接收消息
```
你：我今天完成了跑步！
```

### 2️⃣ 理解意图（Router 路由）
```
系统分析：这是关于"习惯"的消息
→ 路由到"习惯追踪"节点
```

### 3️⃣ 查询数据
```
从数据库查询：
- 你有哪些习惯？
- 最近打卡情况如何？
- 成功/失败的原因是什么？
```

### 4️⃣ AI 处理
```
LLM 根据数据生成响应：
"太棒了！这是你本周第3次完成跑步。
上次成功也是天气好的时候，
看来好天气是你的成功因素！"
```

### 5️⃣ 返回响应 + 保存记录
```
- 显示 AI 的回复
- 保存到数据库
- 记录打卡记录
```

---

## 🔄 完整架构图

```
用户消息
    ↓
【路由器 Router】
    ├─ 检测关键词
    ├─ 判断意图
    └─ 分发到对应节点
         ↓
    ┌────┴────┬────────┬─────────┬──────────┬──────┐
    ↓         ↓        ↓         ↓          ↓      ↓
【习惯】  【计划】  【反思】  【决策】  【目标】【聊天】
    │         │        │         │          │      │
    ├─查数据  ├─查习惯 ├─查历史  ├─查决策  ├─查目标├─无需数据
    ├─AI分析  ├─AI规划 ├─AI引导  ├─AI提问  ├─AI拆解├─AI聊天
    └─存记录  └─存计划 └─存反思  └─存决策  └─存目标└─存对话
         ↓         ↓        ↓         ↓          ↓      ↓
                      返回响应给用户
```

---

## 📦 6个核心节点详解

### 1. Router（路由器）- 交通警察 🚦
**作用**：分析用户说什么，决定该由谁处理

**关键词映射**：
```python
"习惯、打卡、跑步" → 习惯节点
"决策、选择、要不要" → 决策节点
"简报、今天计划" → 计划节点
"反思、回顾、心情" → 反思节点
"目标、想学、打算" → 目标节点
其他 → 聊天节点
```

---

### 2. Habit（习惯追踪）- 健身教练 🏃
**作用**：帮你追踪和改善习惯

**功能**：
- ✅ 记录打卡
- ✅ 找成功模式（什么时候容易坚持）
- ✅ 找失败原因（什么阻碍了你）
- ✅ 给个性化建议

**数据库操作**：
```sql
-- 查询用户的习惯
SELECT * FROM habits WHERE user_id = ?

-- 查询打卡记录
SELECT * FROM habit_records WHERE user_id = ?

-- 保存新记录
INSERT INTO habit_records (user_id, habit_id, status, context)
```

**示例对话**：
```
你：我今天完成了跑步！
AI：太棒了！是什么让你今天成功的？
你：天气很好，下午没有会议
AI：记下了！好天气和时间充裕是你的成功因素
```

---

### 3. Plan（每日计划）- 秘书 📋
**作用**：给你生成个性化的每日简报

**分析内容**：
- 📊 今天的习惯任务
- ⚡ 能量预测（基于睡眠、习惯）
- 🎯 重点目标
- ⚠️ 风险提醒
- 💪 鼓励的话

**数据来源**：
```python
habits = db.get_user_habits(user_id)
goals = db.get_user_goals(user_id)
reflections = db.get_recent_reflections(user_id)
```

**示例输出**：
```
📅 11月11日 简报

⚡ 能量指数：7/10
你昨天完成了跑步，状态不错！

🎯 今日重点：
1. 完成英语学习（第5天）
2. 晚上跑步（趁天气好）

⚠️ 风险提醒：
今天下午有3个会议，可能会累
建议跑步安排在早上

💪 加油：
连续4天坚持，你很棒！
```

---

### 4. Reflect（深度反思）- 心理咨询师 💭
**作用**：通过对话帮你认识自己

**特点**：
- ❌ 不评判
- ✅ 提问引导
- ✅ 发现模式
- ✅ 情绪洞察

**对话示例**：
```
你：今天感觉有点累
AI：是什么让你感到累呢？

你：开了好多会，都在扯皮
AI：听起来会议让你很挫败。这种感觉是第一次还是经常出现？

你：经常这样，感觉效率很低
AI：我注意到你连续3天提到"会议"和"效率低"，
    这可能是持续的压力源...
```

**数据库保存**：
```sql
INSERT INTO reflections (
    user_id, date, conversation, 
    insights, patterns
) VALUES (?, ?, ?, ?, ?)
```

---

### 5. Coach（决策&目标）- 人生导师 🎓
**作用**：帮你做决策和拆解目标

#### 5a. 决策支持
```
你：周末要不要去爬山？
AI：让我帮你理清思路：
    1. 你的身体状态如何？
    2. 天气适合吗？
    3. 有其他计划冲突吗？

你：身体还行，天气不错，没其他计划
AI：你过去3次爬山都感觉很好，
    而且最近压力大，爬山可以放松...
```

#### 5b. 目标拆解
```
你：我想学好英语
AI：很好！你现在的英语水平如何？

你：能看懂简单文章，但不会说
AI：好的，我帮你拆解成21天计划：

第1周：建立习惯
- 每天跟读10分钟
- 背20个单词

第2周：输出练习
- 每天录音5分钟
- 写简单日记

第3周：真实对话
- 用AI模拟对话
- 找language partner
```

---

### 6. Chat（普通聊天）- 朋友 💬
**作用**：不涉及数据的普通对话

**示例**：
```
你：今天天气真好
AI：是啊，这样的天气最适合出去走走了

你：你觉得人生的意义是什么
AI：这是个深刻的问题...（哲学讨论）
```

---

## 🗄️ 数据库设计

### 核心表

```sql
users          -- 用户信息
habits         -- 习惯定义
habit_records  -- 打卡记录
goals          -- 目标
reflections    -- 反思记录
decisions      -- 决策记录
chat_history   -- 聊天历史
daily_briefs   -- 每日简报
```

### 数据流动

```
用户操作 → 保存到数据库 → AI分析历史 → 给出个性化建议
```

---

## 🆕 新用户流程

### 现状：没有引导 ❌
新用户进来直接聊天，不知道能做什么

### 应该怎么做：✅

#### 方案1：简单引导
```
欢迎！我是 LifeOS，你的智能生活助手。

我可以帮你：
1. 🏃 追踪习惯
2. 🔮 做决策
3. 🎯 实现目标
4. 💭 深度反思

试试说：
• "我想养成跑步的习惯"
• "今天要不要去健身房？"
• "给我今天的简报"
```

#### 方案2：互动引导（更好）
```
欢迎！👋 我是 LifeOS

我注意到你是新用户，让我帮你开始吧！

首先，你想：
A) 养成一个新习惯
B) 做一个决策
C) 设定一个目标
D) 随便聊聊

请输入 A/B/C/D
```

#### 方案3：问卷式（最完整）
```
Step 1: 你通常几点起床？
Step 2: 你有什么想改变的习惯？
Step 3: 你最大的挑战是什么？
...

根据回答 → 创建个性化的初始习惯
```

---

## 🔧 添加用户区分 + 新手引导

我现在就帮你实现！包括：

1. ✅ **用户注册登录**
2. ✅ **新用户欢迎流程**
3. ✅ **引导创建第一个习惯**
4. ✅ **Token认证系统**

准备好了吗？我开始写代码！🚀
